#!/usr/bin/env bash
#
# Pre-commit hook for FHIRfly public SDK repos.
#
# Checks:
#   1. Identity leak scan — blocks commits containing personal identity patterns
#   2. Secret detection — blocks commits containing API keys or tokens
#   3. TypeScript typecheck — ensures types are sound
#   4. Lint — ensures code style compliance
#
# Setup:
#   git config core.hooksPath .hooks
#
# Identity blocklist (not checked in — lives outside the repo):
#   ../.config/identity-blocklist            (shared across all SDK repos)
#   .identity-blocklist                      (repo-local override, gitignored)
#

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FAILED=0

# --- 1. Identity leak scan ---
# Look for blocklist: repo-local first, then shared user config
# Searches $HOME and common home dirs to handle containers where $HOME is overridden
BLOCKLIST=""
for candidate in ".identity-blocklist" "../.config/identity-blocklist"; do
  if [ -f "$candidate" ]; then
    BLOCKLIST="$candidate"
    break
  fi
done

if [ -n "$BLOCKLIST" ]; then
  # Build grep pattern from blocklist (skip comments and empty lines)
  PATTERNS=$(grep -v '^\s*#' "$BLOCKLIST" | grep -v '^\s*$' | paste -sd'|' -)
  if [ -n "$PATTERNS" ]; then
    # Check only staged file contents (not the whole repo)
    LEAKED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | while read -r file; do
      if [ -f "$file" ] && git show ":$file" 2>/dev/null | grep -iEq "$PATTERNS"; then
        echo "$file"
      fi
    done)

    if [ -n "$LEAKED_FILES" ]; then
      echo -e "${RED}BLOCKED: Identity patterns found in staged files:${NC}"
      for f in $LEAKED_FILES; do
        echo -e "  ${RED}$f${NC}"
        git show ":$f" | grep -inE "$PATTERNS" | head -3 | while read -r line; do
          echo -e "    ${YELLOW}$line${NC}"
        done
      done
      echo -e "${RED}Edit ../.config/identity-blocklist to update patterns.${NC}"
      FAILED=1
    fi
  fi
fi

# --- 2. Secret detection ---
SECRET_PATTERNS='ffly_(dev|live|test)_[A-Za-z0-9]{20,}|AKIA[0-9A-Z]{16}|sk-[a-zA-Z0-9]{20,}|-----BEGIN (RSA |EC )?PRIVATE KEY'
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
if [ -n "$STAGED_FILES" ]; then
  SECRET_HITS=$(echo "$STAGED_FILES" | while read -r file; do
    if [ -f "$file" ] && git show ":$file" 2>/dev/null | grep -Eq "$SECRET_PATTERNS"; then
      echo "$file"
    fi
  done)

  if [ -n "$SECRET_HITS" ]; then
    echo -e "${RED}BLOCKED: Possible secrets/API keys found in staged files:${NC}"
    for f in $SECRET_HITS; do
      echo -e "  ${RED}$f${NC}"
    done
    FAILED=1
  fi
fi

# --- 3. TypeScript typecheck ---
if [ -f "tsconfig.json" ]; then
  echo -e "${GREEN}Running typecheck...${NC}"
  if ! npm run typecheck --silent 2>&1; then
    echo -e "${RED}Typecheck failed.${NC}"
    FAILED=1
  fi
fi

# --- 4. Lint ---
if npm run lint --silent 2>&1; then
  : # success
else
  echo -e "${RED}Lint failed.${NC}"
  FAILED=1
fi

if [ $FAILED -ne 0 ]; then
  echo -e "\n${RED}Pre-commit checks failed. Fix the issues above or use --no-verify to bypass.${NC}"
  exit 1
fi

echo -e "${GREEN}All pre-commit checks passed.${NC}"
